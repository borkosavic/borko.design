---
import ProjectLayout from '../../layouts/ProjectLayout.astro';
import { getCollection } from 'astro:content';

interface ProjectFrontmatter {
  title: string;
  description: string;
  slug: string;
  accent: string;
  image?: string;
  tags?: string[];
  timeline?: string;
  technologies?: string[];
}

interface ProjectNav {
  title: string;
  description: string;
  slug: string;
  color: string;
  image: string;
}

interface Props {
  project: ProjectFrontmatter;
  previousProject?: ProjectNav;
  nextProject?: ProjectNav;
  content: string;
}

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((entry, index) => {
    const nav = (proj: any) => ({
      title: proj.data.title,
      description: proj.data.description,
      slug: proj.data.slug,
      color: proj.data.accent,
      image: proj.data.image ?? ''
    });
    return {
      params: { project: entry.slug },
      props: {
        project: entry.data as ProjectFrontmatter,
        content: entry.body,
        previousProject: index > 0 ? nav(projects[index - 1]) : undefined,
        nextProject: index < projects.length - 1 ? nav(projects[index + 1]) : undefined,
      },
    };
  });
}

const { project, previousProject, nextProject, content } = Astro.props as Props;

// Robust image import for project images
let imageSrc = '';
if (project.image) {
  try {
    imageSrc = (await import(`../../assets/${project.image}`)).default.src;
  } catch {
    imageSrc = '';
  }
}
---

<ProjectLayout
  title={project.title}
  description={project.description}
  color={project.accent}
  previousProject={previousProject}
  nextProject={nextProject}
>
  <div class="space-y-12">
    <section>
      <h2 class="text-2xl font-bold">About the Project</h2>
      <div class="mt-6 prose prose-lg">
        {content}
      </div>
      {project.image && (
        imageSrc ? (
          <img src={imageSrc} alt={project.title} class="w-full h-auto rounded-lg shadow-xl mt-8" loading="lazy" />
        ) : (
          <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 mt-8">
            No Image Found
          </div>
        )
      )}
    </section>
  </div>
  <div slot="project-details" class="space-y-4">
    {project.timeline && (
      <div>
        <h3 class="font-medium text-gray-900">Timeline</h3>
        <p class="mt-1 text-gray-600">{project.timeline}</p>
      </div>
    )}
    {project.technologies && project.technologies.length > 0 && (
      <div>
        <h3 class="font-medium text-gray-900">Technologies</h3>
        <ul class="mt-1 space-y-1 text-gray-600">
          {project.technologies.map((tech) => (
            <li>{tech}</li>
          ))}
        </ul>
      </div>
    )}
  </div>
</ProjectLayout>